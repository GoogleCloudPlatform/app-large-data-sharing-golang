# API
## Upload:
This API uses `multipart/form-data` to upload multiple files along with the relevant tags in a single request.

- Endpoint: POST /api/files

- Request Body: multipart/form-data
    - `tags`: `string` (required), multiple tags separated by space `" "`.
	- `files`: `[file]` (required), the files been uploaded. The type is "file" of HTML input type in multipart/form-data.

- Response Code:
    - `201`: Resource created successfully.
    - `400`: Bad Request.

- Response Body:
    - 201: 
        ```json
        {
            "files": [
                {
                    "id": "string", // unique id to identify the object, generated by UUID version 4
                    "name": "string",   // the file name of the uploaded file
                    "size": "number",   // the file size in bytes
                    "tags": ["string"],
                    "url": "string",
                    "thumbUrl": "string",
                    "orderNo": "string",    // used for ordering, based on the last update time
                    "createTime" : "date",  // datetime in ISO 8601 `YYYY-MM-DDThh:mm:ss.sssZ`
                    "updateTime" : "date"   // datetime in ISO 8601 `YYYY-MM-DDThh:mm:ss.sssZ`
                },
            ]
        }
        ```  
        ex:
        ```json
        {
            "files" : [
                {
                    "id": "ff2b2918-8e92-4e4a-a40e-a834c14a2f8d",
                    "name": "myfile1.jpg",
                    "size": 342123,
                    "tags": ["mytag1", "mytag2"],
                    "url": "http://35.190.54.190/ff2b2918-8e92-4e4a-a40e-a834c14a2f8d",
                    "thumbUrl": "http://35.190.54.190/ff2b2918-8e92-4e4a-a40e-a834c14a2f8d-small",
                    "orderNo": "1679459547365-ff2b2918-8e92-4e4a-a40e-a834c14a2f8d",
                    "createTime": "2023-02-01T08:30.00.000Z",
                    "updateTime" : "2023-02-01T09:30.00.000Z",
                },
                {
                    "id": "876b4c81-b77d-4ea7-9465-fa8fd6cb6f4a",
                    "name": "myfile2.jpg",
                    "size": 134393,
                    "tags": ["mytag1"],
                    "url": "http://35.190.54.190/876b4c81-b77d-4ea7-9465-fa8fd6cb6f4a",
                    "thumbUrl": "http://35.190.54.190/876b4c81-b77d-4ea7-9465-fa8fd6cb6f4a-small",
                    "orderNo": "1679459603899-876b4c81-b77d-4ea7-9465-fa8fd6cb6f4a",
                    "createTime": "2023-02-01T08:31.00.000Z",
                    "updateTime" : "2023-02-01T09:31.00.000Z",
                }
            ]
        },
        ```

## Update:
This API enables users to modify the file identified by the ID.
The update action should remove the old file from the bucketk, create new one, and update its new `path` in `filemeta`. 

- Endpoint: PUT /api/files/{id}

- Request Body: multipart/form-data
    - `tags`: `string` (required), multiple tags separated by space `" "`.
    - `file`: `file` (optional), the file been uploaded, ignore to keep old file. The type is "file" of HTML input type in multipart/form-data.
 
 - Response Code:
    - `200`: OK.   
    - `400`: Bad Request.
    - `404`: Not Found (file not found).

- Response Body:
    - `200`: 
        ```json
        {
            "file": {
                "id": "string", // unique id to identify the object, generated by UUID version 4
                "name": "string",   // the file name of the uploaded file
                "size": "number",   // the file size in bytes
                "tags": ["string"],
                "url": "string",
                "thumbUrl": "string",
                "orderNo": "string",    // used for ordering, based on the last update time
                "createTime" : "date",  // datetime in ISO 8601 `YYYY-MM-DDThh:mm:ss.sssZ`
                "updateTime" : "date"   // datetime in ISO 8601 `YYYY-MM-DDThh:mm:ss.sssZ`
            }
        }
        ```  
        ex:
        ```json
        {
            "file" : {
                "id": "ff2b2918-8e92-4e4a-a40e-a834c14a2f8d",
                "name": "myfile1.jpg",
                "size": 342123,
                "tags": ["mytag1", "mytag2"],
                "url": "http://35.190.54.190/8259dde9-5365-4c16-af79-34389f627654",
                "thumbUrl": "http://35.190.54.190/8259dde9-5365-4c16-af79-34389f627654-small",
                "orderNo": "1679467643234-8259dde9-5365-4c16-af79-34389f627654",
                "createTime": "2023-02-01T08:30.00.000Z",
                "updateTime" : "2023-02-01T09:30.00.000Z",
            }
        }

## Delete:
This API enables users to delete the file identified by the ID.

- Endpoint: DELETE /api/files/{id}

- Response Code:
    - `204`: No Content (success).
    - `404`: Not Found (file not found).

## List:
This API offers optional query parameters `tags` and `orderNo` to filter files. The files are listed in order of `orderNo` based on last update time with a default page size of 50.

- Endpoint: GET /api/files?tags={tag1 tag2 ...}&orderNo={orderNo}&size={size}

- Query Parameters:
	- `tags`: `string` (optional), multiple tags separated by space `" "`, aka `%20`.
    - `orderNo`: `string` (optional), list files with orderNo larger than given orderNo.
    - `size`: `int` (optional), page size, defaults to 50 if absent. 

- Response Code:
	- `200`: OK.
    - `400`: Bad Request.

- Response Body:
    - 200:
        ```json
        {
            "files": [
                {
                    "id": "string", // unique id to identify the object, generated by UUID version 4
                    "name": "string",   // the file name of the uploaded file
                    "size": "number",   // the file size in bytes
                    "tags": ["string"],
                    "url": "string",
                    "thumbUrl": "string",
                    "orderNo": "string",    // used for ordering, based on the last update time
                    "createTime" : "date",  // datetime in ISO 8601 `YYYY-MM-DDThh:mm:ss.sssZ`
                    "updateTime" : "date"   // datetime in ISO 8601 `YYYY-MM-DDThh:mm:ss.sssZ`
                }
            ]
        }
        ```
        ex:
        ```json
        {
            "files" : [
                {
                    "id": "ff2b2918-8e92-4e4a-a40e-a834c14a2f8d",
                    "name": "myfile1.jpg",
                    "size": 342123,
                    "tags": ["mytag1", "mytag2"],
                    "url": "http://35.190.54.190/8259dde9-5365-4c16-af79-34389f627654",
                    "thumbUrl": "http://35.190.54.190/8259dde9-5365-4c16-af79-34389f627654-small",
                    "orderNo": "1679467643234-8259dde9-5365-4c16-af79-34389f627654",
                    "createTime": "2023-02-01T08:30.00.000Z",
                    "updateTime" : "2023-02-01T09:30.00.000Z",
                },
                {
                    "id": "876b4c81-b77d-4ea7-9465-fa8fd6cb6f4a",
                    "name": "myfile2.jpg",
                    "size": 134393,
                    "tags": ["mytag1"],
                    "url": "http://35.190.54.190/876b4c81-b77d-4ea7-9465-fa8fd6cb6f4a",
                    "thumbUrl": "http://35.190.54.190/876b4c81-b77d-4ea7-9465-fa8fd6cb6f4a-small",
                    "orderNo": "1679459603899-876b4c81-b77d-4ea7-9465-fa8fd6cb6f4a",
                    "createTime": "2023-02-01T08:31.00.000Z",
                    "updateTime" : "2023-02-01T09:31.00.000Z",
                }
            ]
        },
        ```

## Reset:
This API resets the server, deleting all files in the system.

- Endpoint: DELETE /api/reset

- Response Code:
    - `204`: No Content (success).

## Health Check:
This API is provided for Cloud Run to check the health of the server.

- Endpoint: GET /api/healthchecker

- Response Code:
    - `204`: No Content (success).



# Cloud Storage:
The file should be stored in the Cloud storage bucket referenced by the `LDS_BUCKET` environment variable, 
and it's filename should be generated using UUID version 4. 
The file name should be stored in field `path` of fileMeta.

- `bucket`: Defined by environment variable `{LDS_BUCKET}` with default value `lds_data`.
- `file name`: The unique ID generated using UUID version.


# NoSql DB:
## Firestore:
The file's meta should be stored in the Firestore, and the document name should be the filename of the file stored in Cloud Storage. The creation time and last update time of the document can be queried from its metadata.

- collections(tables): `fileMeta`
- documents: `{id}`, the ID used to identify the file, generated by UUID version 4.
    - `path`: `string`, the path relative to the bucket, where the file is stored.
    - `name`: `string`, the original file name.
    - `tags`: `[string]`, the tags this file belongs to.
    - `size`: `integer`, the file size in bytes.

# Server Environment Variables
The configuration of the servers is defined by the following environment variables.

- `LDS_REST_URL`: The url of REST server.
- `LDS_REST_PORT`: The port of the REST server, default `8000`.
- `LDS_PROJECT`: The Google Cloud project ID.
- `LDS_BUCKET`: The cloud storage bucket name, default `lds_data`.
- `LDS_RESOURCE_PATH`: The resource path, default `/resource`.
